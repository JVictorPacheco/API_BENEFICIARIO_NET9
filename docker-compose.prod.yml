# O primeiro serviço é a API .NET 9 em modo de produção. ele é construído a partir do 
#Dockerfile na raiz do projeto, usando o estágio "runtime". A API escuta na porta 5000 e 
#depende do serviço PostgreSQL para o banco de dados. As variáveis de ambiente configuram 
#o ambiente como "Production" e definem a string de conexão do banco de dados.
services:
  # API .NET 9 - Production
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: beneficiario-api-prod
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=${DATABASE_CONNECTION_STRING}
    depends_on:
      - postgres
    networks:
      - beneficiario-network
    restart: always

 # Esse serviço configura um contêiner PostgreSQL usando a imagem oficial "postgres:16-alpine". 
 #Ele mapeia a porta padrão 5432, define variáveis de ambiente para o nome do banco de dados, 
 #usuário e senha, e monta um volume para persistência dos dados. Também inclui uma verificação de integridade para garantir 
 #que o banco de dados esteja pronto antes que a API tente se conectar.
 # já é uma imagem oficial do PostgreSQL otimizada para tamanho com Alpine Linux. Que já tem no dockerhub. Portanto ele não foi criadno no docker file, igual a api
# PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: beneficiario-postgres-prod
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - beneficiario-network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data:

networks:
  beneficiario-network:
    driver: bridge
